<!DOCTYPE html>
<html>

<head>
    <title>Google OAuth 2.0 Example</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script async defer src="https://accounts.google.com/gsi/client" onload="initClient()">
    </script>
</head>

<body>


    <div class="card" style="width: 18rem;">
        <div class="card-body">
            <h5 class="card-title">Card title</h5>
            <p id="emails_summary" class="card-text"></p>
            <button id="authorizeBtn" class="btn btn-primary" disabled onclick="client.requestCode();">Gmail</button>
        </div>
    </div>

    <div class="card" style="width: 18rem;">
        <div class="card-body">
            <h5 class="card-title">Card title</h5>
            <p id="reviews_summary" class="card-text"></p>
            <button class="btn btn-primary" onclick="fetchReviews();">Maps reviews</button>
        </div>
    </div>



    <script>
        let client;
        function initClient() {
            client = google.accounts.oauth2.initCodeClient({
                client_id: '{{ context.client_id }}',
                scope: '{{ context.scopes[0] }}',
                ux_mode: 'popup',
                callback: (response) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', 'http://127.0.0.1:5000/oauth', true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    xhr.setRequestHeader('X-Requested-With', 'XmlHttpRequest');
                    xhr.onload = function () {
                        console.log('Auth code response: ' + xhr.responseText);
                        document.getElementById('emails_summary').innerHTML = xhr.responseText;
                    };
                    xhr.send('code=' + response.code);
                },
            });

            const authorizeBtn = document.getElementById('authorizeBtn');
            authorizeBtn.disabled = false;
        }

        function fetchReviews() {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', 'http://127.0.0.1:5000/reviews', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onload = function () {
                document.getElementById('reviews_summary').innerHTML = xhr.responseText;
            };
            xhr.send();
        }
    </script>
</body>

</html>